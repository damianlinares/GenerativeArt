<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LA INDIVIDUACIÓN: El Espejo de la Sombra - Damian Alejandro Linares</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            width: 100%;
            height: 100vh;
            background: radial-gradient(circle at center, #1a0a2a 0%, #0a0510 100%);
            overflow: hidden;
            font-family: 'Georgia', serif;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        canvas {
            display: block;
            box-shadow: 0 0 50px rgba(150, 50, 255, 0.3), inset 0 0 100px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(200, 100, 255, 0.2);
            border-radius: 8px;
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #000 0%, #2a0a3a 30%, #1a0a4a 70%, #000 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 3s ease-out;
        }

        .loading-text {
            color: #fff;
            font-size: clamp(2rem, 6vw, 4rem);
            text-align: center;
            line-height: 1.4;
            letter-spacing: 4px;
            animation: shadowBreathing 4s infinite;
            text-shadow: 0 0 30px rgba(200, 100, 255, 0.8), 0 0 60px rgba(150, 50, 200, 0.4);
            font-weight: 300;
            margin-bottom: 2rem;
        }

        .loading-subtitle {
            color: rgba(255, 255, 255, 0.7);
            font-size: clamp(1rem, 2vw, 1.5rem);
            letter-spacing: 2px;
            animation: pulse 3s infinite;
            font-style: italic;
        }

        @keyframes shadowBreathing {
            0%, 100% { opacity: 0.8; transform: scale(1) rotateX(0deg); }
            25% { opacity: 0.9; transform: scale(1.01) rotateX(1deg); }
            50% { opacity: 1; transform: scale(1.02) rotateX(0deg); }
            75% { opacity: 0.9; transform: scale(1.01) rotateX(-1deg); }
        }

        .philosophical-panel {
            position: fixed;
            top: 30px;
            right: 30px;
            width: 400px;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(25px);
            border: 2px solid rgba(200, 100, 255, 0.6);
            border-radius: 20px;
            padding: 30px;
            color: #fff;
            font-size: 14px;
            line-height: 1.8;
            z-index: 100;
            transform: translateX(110%);
            transition: transform 1s ease-out;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.8);
        }

        .philosophical-panel.visible {
            transform: translateX(0);
        }

        .panel-title {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 25px;
            color: #d478ff;
            text-align: center;
            letter-spacing: 3px;
            text-shadow: 0 0 20px rgba(200, 100, 255, 0.6);
            border-bottom: 1px solid rgba(200, 100, 255, 0.3);
            padding-bottom: 15px;
        }

        .jung-quote {
            font-style: italic;
            color: rgba(255, 255, 255, 0.9);
            margin: 20px 0;
            padding: 15px;
            border-left: 3px solid rgba(200, 100, 255, 0.7);
            background: rgba(200, 100, 255, 0.05);
            border-radius: 5px;
        }

        .concept-section {
            margin: 20px 0;
            padding: 20px;
            background: rgba(200, 100, 255, 0.08);
            border-radius: 12px;
            border: 1px solid rgba(200, 100, 255, 0.2);
        }

        .concept-section h4 {
            color: #d478ff;
            margin-bottom: 12px;
            font-size: 16px;
        }

        .controls-advanced {
            position: fixed;
            top: 30px;
            left: 30px;
            background: rgba(0, 0, 0, 0.92);
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 15px;
            padding: 25px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 13px;
            z-index: 100;
            max-width: 320px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6);
        }

        .controls-advanced h4 {
            color: #fff;
            margin-bottom: 15px;
            font-size: 17px;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .control-group {
            margin: 12px 0;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .psychological-state {
            position: fixed;
            bottom: 30px;
            left: 30px;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid rgba(200, 100, 255, 0.5);
            border-radius: 15px;
            padding: 25px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 13px;
            z-index: 100;
            max-width: 350px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6);
        }

        .state-indicator {
            display: flex;
            align-items: center;
            margin: 8px 0;
        }

        .state-bar {
            width: 100px;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            margin-left: 10px;
            overflow: hidden;
        }

        .state-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff4444, #ffaa44, #44ff44);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .archetype-display {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid rgba(200, 100, 255, 0.5);
            border-radius: 15px;
            padding: 25px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 12px;
            z-index: 100;
            max-width: 300px;
        }

        .fade-out {
            opacity: 0;
        }

        @media (max-width: 1200px) {
            .philosophical-panel, .controls-advanced, .psychological-state, .archetype-display {
                position: relative;
                width: 90%;
                margin: 10px auto;
                transform: none;
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-text">LA INDIVIDUACIÓN</div>
        <div class="loading-subtitle">El Espejo de la Sombra Jungiana</div>
    </div>
    
    <div class="philosophical-panel" id="philosophicalPanel">
        <div class="panel-title">PSICOLOGÍA ANALÍTICA</div>
        
        <div class="jung-quote">
            "Hasta que no hagas consciente lo inconsciente, dirigirá tu vida y lo llamarás destino."
            <div style="text-align: right; margin-top: 10px; color: rgba(255,255,255,0.6);">— Carl Gustav Jung</div>
        </div>
        
        <div class="concept-section">
            <h4>LA SOMBRA PERSONAL</h4>
            <p>Representa todos los aspectos de la personalidad que el ego consciente ha rechazado. 
            No es intrínsecamente maligna, sino la suma de potencialidades no desarrolladas.</p>
        </div>
        
        <div class="concept-section">
            <h4>PROCESO DE INDIVIDUACIÓN</h4>
            <p>La integración progresiva de los contenidos inconscientes hacia la totalidad 
            psíquica. No es eliminar la sombra, sino dialogar conscientemente con ella.</p>
        </div>
        
        <div class="concept-section">
            <h4>INTERACCIÓN:</h4>
            <p><strong>Aproximación:</strong> Confronta tu sombra<br>
            <strong>Diálogo:</strong> Activa los arquetipos<br>
            <strong>Integración:</strong> Unifica los opuestos</p>
        </div>
    </div>

    <div class="controls-advanced">
        <h4>EXPLORACIÓN PSÍQUICA</h4>
        <div class="control-group">
            <strong>RATÓN:</strong> Aproximación a la Sombra
        </div>
        <div class="control-group">
            <strong>CLICK:</strong> Reiniciar individuación
        </div>
        <div class="control-group">
            <strong>ESPACIO:</strong> Acelerar integración
        </div>
        <div class="control-group">
            <strong>S:</strong> Confrontación directa
        </div>
        <div class="control-group">
            <strong>A:</strong> Activar arquetipos
        </div>
        <div class="control-group">
            <strong>M:</strong> Mandala de totalidad
        </div>
        <div class="control-group">
            <strong>R:</strong> Regenerar sombra
        </div>
        <div class="control-group">
            <strong>I:</strong> Información filosófica
        </div>
    </div>

    <div class="psychological-state">
        <h4 style="color: #d478ff; margin-bottom: 15px;">ESTADO PSICOLÓGICO</h4>
        
        <div class="state-indicator">
            <span>Consciencia:</span>
            <div class="state-bar"><div class="state-fill" id="consciousnessBar"></div></div>
            <span id="consciousnessText">0%</span>
        </div>
        
        <div class="state-indicator">
            <span>Integración:</span>
            <div class="state-bar"><div class="state-fill" id="integrationBar"></div></div>
            <span id="integrationText">0%</span>
        </div>
        
        <div class="state-indicator">
            <span>Individuación:</span>
            <div class="state-bar"><div class="state-fill" id="individuationBar"></div></div>
            <span id="individuationText">0%</span>
        </div>
        
        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2);">
            <strong>Fase actual:</strong> <span id="currentPhase">Inconsciencia inicial</span>
        </div>
    </div>

    <div class="archetype-display">
        <h4 style="color: #d478ff; margin-bottom: 15px;">ARQUETIPOS ACTIVOS</h4>
        <div id="archetypeList">
            <div>Persona: <span id="personaLevel">Dormida</span></div>
            <div>Sombra: <span id="shadowLevel">Fragmentada</span></div>
            <div>Anima/Animus: <span id="animaLevel">Oculta</span></div>
            <div>Self: <span id="selfLevel">Potencial</span></div>
        </div>
        
        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2);">
            <strong>Símbolo dominante:</strong><br>
            <span id="dominantSymbol">El Misterio</span>
        </div>
    </div>

    <script>
        // --- EVOLUCIÓN --- Variables para la reactividad de la Sombra
        let prevMouseX = 0;
        let prevMouseY = 0;

        // Sistema psicológico complejo
        let psyche = {
            // Elementos estructurales
            ego: { x: 0, y: 0, energia: 1, estabilidad: 1 },
            sombra: { 
                x: 0, y: 0, radio: 0, puntos: [], fragmentos: [],
                energia: 0, visibilidad: 0, hostilidad: 0.3, // Hostilidad añadida
                arquetipos: []
            },
            anima: { energia: 0, manifestaciones: [] },
            self: { energia: 0, mandala: [], unidad: 0 },
            
            // --- EVOLUCIÓN --- Nuevos elementos: Complejos
            complejos: [],

            // Estados dinámicos
            consciencia: 0,
            integracion: 0,
            individuacion: 0,
            fase: 0,
            tiempo: 0,
            
            // Elementos visuales
            chakras: [],
            particulas: [],
            simbolos: [],
            conexiones: [],
            
            // Estados de interacción
            loadingComplete: false,
            modoConfronta: false,
            arquetiposActivos: false,
            mandalaVisible: false,

            // --- EVOLUCIÓN --- Estado para el clímax
            estadoUnificacion: 'ninguno' // ninguno, viajando, unificado
        };

        // Fases de la individuación según Jung
        const FASES_INDIVIDUACION = [
            "Inconsciencia inicial",
            "Encuentro con la Persona",
            "Confrontación con la Sombra",
            "Encuentro con Anima/Animus", 
            "Desarrollo del Self",
            "Individuación realizada"
        ];

        const ARQUETIPOS_SIMBOLOS = [
            "El Misterio", "El Espejo", "La Serpiente", "El Árbol",
            "La Corona", "El Círculo", "La Espiral", "El Ojo"
        ];

        function setup() {
            createCanvas(windowWidth, windowHeight);
            colorMode(HSB, 360, 100, 100, 100);
            
            inicializarPsique();
            setTimeout(ocultarPantallaCarga, 3000);
            prevMouseX = mouseX;
            prevMouseY = mouseY;
        }

        function inicializarPsique() {
            // Resetear estado de unificación
            psyche.estadoUnificacion = 'ninguno';

            // Posición del ego (centro-izquierda)
            psyche.ego.x = width * 0.3;
            psyche.ego.y = height * 0.5;
            
            // Configuración de la sombra (centro-derecha)
            psyche.sombra.x = width * 0.7;
            psyche.sombra.y = height * 0.5;
            psyche.sombra.radio = height * 0.25;
            
            generarGeometriaSombra();
            inicializarChakras();
            crearParticulas();
            generarSimbolos();

            // --- EVOLUCIÓN --- Generar complejos psíquicos
            generarComplejos();
        }
        
        // --- EVOLUCIÓN --- Función para crear los complejos
        function generarComplejos() {
            psyche.complejos = [];
            for(let i = 0; i < 5; i++) {
                psyche.complejos.push({
                    x: width * 0.5 + random(-width*0.2, width*0.2),
                    y: height * 0.5 + random(-height*0.3, height*0.3),
                    radio: random(15, 30),
                    energia: 1,
                    ruidoOffset: random(1000),
                    velocidad: random(0.1, 0.4),
                    activado: false,
                    tiempoActivado: 0
                });
            }
        }

        function generarGeometriaSombra() {
            psyche.sombra.puntos = [];
            psyche.sombra.fragmentos = [];
            
            // Contorno fluido de la sombra
            for (let i = 0; i < 60; i++) {
                psyche.sombra.puntos.push({
                    angulo: map(i, 0, 60, 0, TWO_PI),
                    distancia: random(psyche.sombra.radio * 0.6, psyche.sombra.radio * 1.1),
                    ruidoOffset: random(2000),
                    velocidad: random(0.2, 0.7),
                    intensidad: random(0.5, 1.0)
                });
            }
            
            // Fragmentos internos (aspectos rechazados)
            for(let i = 0; i < 25; i++) {
                psyche.sombra.fragmentos.push({
                    x: random(-psyche.sombra.radio * 0.7, psyche.sombra.radio * 0.7),
                    y: random(-psyche.sombra.radio * 0.7, psyche.sombra.radio * 0.7),
                    tam: random(3, 15),
                    rotacion: random(TWO_PI),
                    velocidadRot: random(-0.03, 0.03),
                    alpha: random(30, 80),
                    arquetipo: Math.floor(random(4)),
                    pulsacion: random(1, 3)
                });
            }
        }

        function inicializarChakras() {
            let coloresTradicionales = [0, 30, 60, 120, 210, 240, 275];
            let nombresChakras = ["Raíz", "Sacro", "Plexo", "Corazón", "Garganta", "Tercer Ojo", "Corona"];
            
            psyche.chakras = [];
            for (let i = 0; i < 7; i++) {
                psyche.chakras.push({
                    y: (height * 0.85) - (i * height * 0.09),
                    color: coloresTradicionales[i],
                    nombre: nombresChakras[i],
                    tam: 18,
                    energia: 0,
                    activo: false,
                    resonancia: 0,
                    arquetipos: []
                });
            }
        }

        function crearParticulas() {
            psyche.particulas = [];
            for(let i = 0; i < 80; i++) {
                psyche.particulas.push({
                    x: random(width),
                    y: random(height),
                    vx: random(-0.5, 0.5),
                    vy: random(-0.5, 0.5),
                    tam: random(1, 4),
                    hue: random(240, 320),
                    alpha: random(20, 70),
                    tipo: Math.floor(random(5)),
                    arquetipoVinculo: -1
                });
            }
        }

        function generarSimbolos() {
            psyche.simbolos = [];
            for(let i = 0; i < 12; i++) {
                psyche.simbolos.push({
                    x: random(width * 0.1, width * 0.9),
                    y: random(height * 0.1, height * 0.9),
                    simbolo: ARQUETIPOS_SIMBOLOS[Math.floor(random(ARQUETIPOS_SIMBOLOS.length))],
                    alpha: 0,
                    rotacion: 0,
                    escala: random(0.5, 1.5),
                    energia: 0
                });
            }
        }

        function draw() {
            if (!psyche.loadingComplete) return;
            
            // --- EVOLUCIÓN --- Lógica de Unificación del Self
            if(psyche.estadoUnificacion === 'viajando') {
                psyche.ego.x = lerp(psyche.ego.x, width/2, 0.02);
                psyche.sombra.x = lerp(psyche.sombra.x, width/2, 0.02);
                psyche.ego.y = lerp(psyche.ego.y, height/2, 0.02);
                psyche.sombra.y = lerp(psyche.sombra.y, height/2, 0.02);
                if(dist(psyche.ego.x, psyche.ego.y, width/2, height/2) < 5) {
                    psyche.estadoUnificacion = 'unificado';
                }
            }

            // Fondo dinámico según el estado psicológico
            let bgHue = lerp(240, 280, psyche.integracion);
            let bgSat = lerp(60, 25, psyche.consciencia);
            let bgBright = psyche.modoConfronta ? 1 : lerp(2, 6, psyche.consciencia);
            background(bgHue, bgSat, bgBright);
            
            psyche.tiempo += 0.008;
            
            // Calcular estados psicológicos
            if (psyche.estadoUnificacion !== 'unificado') {
                calcularEstadosPsicologicos();
            }
            
            // Sistema de renderizado por capas
            dibujarCampoEnergetico();
            dibujarParticulas();

            // --- EVOLUCIÓN --- Dibujar complejos
            dibujarComplejos();

            if (psyche.estadoUnificacion !== 'unificado') {
                dibujarEgo();
                dibujarSombra();
                dibujarConexionesPsiquicas();
            }

            dibujarArquetipos();
            dibujarSimbolos();
            
            if (psyche.mandalaVisible || psyche.estadoUnificacion === 'unificado') {
                dibujarMandalaIndividuacion();
            }
            
            actualizarInterfaz();

            // --- EVOLUCIÓN --- Actualizar posición previa del ratón
            prevMouseX = mouseX;
            prevMouseY = mouseY;
        }

        function calcularEstadosPsicologicos() {
            // Consciencia basada en proximidad y tiempo
            let proximidad = dist(mouseX, mouseY, psyche.sombra.x, psyche.sombra.y);
            let factorProximidad = map(proximidad, width/2, 50, 0, 1, true);
            
            // --- EVOLUCIÓN --- Hostilidad reduce ganancia de consciencia
            let velocidadMouse = dist(mouseX, mouseY, prevMouseX, prevMouseY);
            if (velocidadMouse > 20) {
                 psyche.sombra.hostilidad = lerp(psyche.sombra.hostilidad, 0.9, 0.1);
            } else {
                 psyche.sombra.hostilidad = lerp(psyche.sombra.hostilidad, 0.1, 0.02);
            }
            psyche.consciencia = lerp(psyche.consciencia, factorProximidad * 0.7 + psyche.tiempo * 0.3, 0.01) * (1 - psyche.sombra.hostilidad * 0.5);
            
            // Integración como síntesis de opuestos
            psyche.integracion = (psyche.consciencia + psyche.sombra.energia * 0.8) * 0.6;
            
            // Individuación como proceso total
            psyche.individuacion = (psyche.consciencia * 0.4 + psyche.integracion * 0.6) * (psyche.arquetiposActivos ? 1.2 : 1.0);
            psyche.individuacion = constrain(psyche.individuacion, 0, 1); // Asegurarse que no pase de 1

            // --- EVOLUCIÓN --- Activar unificación al llegar al 100%
            if (psyche.individuacion >= 0.99 && psyche.estadoUnificacion === 'ninguno') {
                psyche.estadoUnificacion = 'viajando';
            }

            // Actualizar energía de la sombra
            psyche.sombra.energia = constrain(psyche.consciencia * 1.5, 0, 1);
            psyche.sombra.visibilidad = psyche.sombra.energia;
            
            // Determinar fase actual
            psyche.fase = Math.floor(psyche.individuacion * FASES_INDIVIDUACION.length);
            psyche.fase = constrain(psyche.fase, 0, FASES_INDIVIDUACION.length - 1);
        }
        
        // --- EVOLUCIÓN --- Nueva función para dibujar complejos
        function dibujarComplejos() {
            for(let c of psyche.complejos) {
                if (c.energia > 0) {
                    let movimientoX = map(noise(c.ruidoOffset + psyche.tiempo * c.velocidad), 0, 1, -1, 1);
                    let movimientoY = map(noise(c.ruidoOffset + 1000 + psyche.tiempo * c.velocidad), 0, 1, -1, 1);
                    c.x += movimientoX;
                    c.y += movimientoY;

                    // Lógica de activación del complejo
                    if (dist(mouseX, mouseY, c.x, c.y) < c.radio && !c.activado) {
                        c.activado = true;
                        c.tiempoActivado = 180; // Duración del efecto en frames
                        psyche.consciencia *= 0.5; // Penalización a la consciencia
                    }

                    if(c.activado) {
                        c.tiempoActivado--;
                        if(c.tiempoActivado <= 0) c.activado = false;
                    }
                    
                    push();
                    translate(c.x, c.y);
                    
                    let alphaComplejo = c.activado ? 100 : 40;
                    let brilloComplejo = c.activado ? 100 : 70;
                    
                    // Aura del complejo
                    for(let i = 2; i >= 0; i--) {
                        noFill();
                        stroke(0, 80, brilloComplejo, alphaComplejo / (i + 1) * (c.activado ? 2 : 1));
                        strokeWeight(1 + i);
                        let pulsacion = c.activado ? sin(frameCount * 0.5) * 10 : sin(psyche.tiempo * 3 + c.ruidoOffset) * 5;
                        ellipse(0, 0, c.radio * 2 + i * 15 + pulsacion);
                    }
                    
                    // Núcleo
                    fill(0, 90, brilloComplejo - 20, 90);
                    noStroke();
                    ellipse(0, 0, c.radio);

                    pop();
                }
            }
        }

        function dibujarCampoEnergetico() {
            // Campo energético del ego
            let egoRadio = lerp(width * 0.15, width * 0.35, psyche.consciencia);
            for(let i = 4; i >= 0; i--) {
                let factor = 1 + (i * 0.2);
                let alpha = lerp(3, 20, psyche.consciencia) / (i + 1);
                noFill();
                stroke(60, 40, 100, alpha);
                strokeWeight(lerp(2, 0.5, i/4));
                let respiracion = sin(psyche.tiempo * 2) * 0.1 + 1;
                ellipse(psyche.ego.x, psyche.ego.y, egoRadio * factor * respiracion);
            }
            
            // Campo energético de la sombra (cuando es consciente)
            if(psyche.sombra.energia > 0.2) {
                let sombraRadio = lerp(psyche.sombra.radio * 0.5, psyche.sombra.radio * 1.5, psyche.sombra.energia);
                for(let i = 3; i >= 0; i--) {
                    let factor = 1 + (i * 0.15);
                    let alpha = psyche.sombra.energia * 18 / (i + 1);
                    noFill();
                    // --- EVOLUCIÓN --- El color ahora es afectado por la hostilidad
                    let hueSombra = lerp(280, 0, psyche.sombra.hostilidad);
                    stroke(hueSombra, 60, 60, alpha);
                    strokeWeight(2 - i * 0.4);
                    ellipse(psyche.sombra.x, psyche.sombra.y, sombraRadio * factor);
                }
            }
        }

        // El resto de funciones de dibujo (dibujarParticulas, dibujarEgo, dibujarSombra, etc.)
        // permanecen mayormente iguales, con pequeños ajustes para acomodar los nuevos estados.
        // Las funciones de la interfaz y de eventos también se mantienen.
        // ... (resto del código sin cambios significativos) ...
        // Se omite el resto del código para brevedad, ya que las funciones principales
        // de dibujo y control no necesitan cambios drásticos, solo interactúan con
        // las nuevas variables del objeto 'psyche'.
         function dibujarParticulas() {
            for(let p of psyche.particulas) {
                let fuerzaEgo = createVector(psyche.ego.x - p.x, psyche.ego.y - p.y);
                fuerzaEgo.mult(0.00005 * psyche.consciencia);
                
                let fuerzaSombra = createVector(psyche.sombra.x - p.x, psyche.sombra.y - p.y);
                fuerzaSombra.mult(0.00003 * psyche.sombra.energia);
                
                p.vx += fuerzaEgo.x + fuerzaSombra.x;
                p.vy += fuerzaEgo.y + fuerzaSombra.y;
                
                p.x += p.vx;
                p.y += p.vy;
                p.vx *= 0.995;
                p.vy *= 0.995;
                
                if(p.x < 0) p.x = width;
                if(p.x > width) p.x = 0;
                if(p.y < 0) p.y = height;
                if(p.y > height) p.y = 0;
                
                noStroke();
                let particleAlpha = p.alpha * (psyche.modoConfronta ? 0.3 : 1);
                fill(p.hue, 60, 90, particleAlpha);
                
                push();
                translate(p.x, p.y);
                rotate(psyche.tiempo * (p.tipo - 2));
                
                switch(p.tipo) {
                    case 0: ellipse(0, 0, p.tam); break;
                    case 1: rect(-p.tam/2, -p.tam/2, p.tam, p.tam); break;
                    case 2: triangle(-p.tam/2, p.tam/2, p.tam/2, p.tam/2, 0, -p.tam/2); break;
                    case 3: 
                        beginShape();
                        for(let a = 0; a < TWO_PI; a += PI/3) {
                            let r = p.tam/2 * (0.8 + sin(a * 3 + psyche.tiempo * 5) * 0.3);
                            vertex(cos(a) * r, sin(a) * r);
                        }
                        endShape(CLOSE);
                        break;
                    case 4:
                        line(-p.tam/2, 0, p.tam/2, 0);
                        line(0, -p.tam/2, 0, p.tam/2);
                        break;
                }
                pop();
            }
        }

        function dibujarEgo() {
            strokeWeight(lerp(1, 6, psyche.consciencia));
            stroke(0, 0, 100, lerp(20, 80, psyche.consciencia));
            line(psyche.ego.x, height * 0.9, psyche.ego.x, height * 0.1);

            let chakrasActivos = 0;
            
            for (let i = 0; i < psyche.chakras.length; i++) {
                let c = psyche.chakras[i];
                c.energia = constrain(psyche.consciencia * 8 - i, 0, 1);
                c.resonancia = psyche.integracion * c.energia;
                c.activo = c.energia > 0.25;
                
                if(c.activo) chakrasActivos++;
                
                let pulsacion = sin(psyche.tiempo * 4 - i * 0.6) * lerp(5, 15, c.energia);
                let tamActual = c.tam + pulsacion;
                
                for(let j = 4; j >= 0; j--) {
                    noStroke();
                    let alphaAura = lerp(2, 35, c.energia) / (j + 1);
                    fill(c.color, 70, 90, alphaAura);
                    ellipse(psyche.ego.x, c.y, tamActual * (1.8 + j * 0.6));
                }
                
                fill(c.color, 80, lerp(40, 100, c.energia), lerp(60, 100, c.energia));
                ellipse(psyche.ego.x, c.y, tamActual);
                
                if(c.energia > 0.4) {
                    push();
                    translate(psyche.ego.x, c.y);
                    rotate(psyche.tiempo * (0.3 + c.energia) * (i % 2 == 0 ? 1 : -1));
                    fill(0, 0, 100, 90);
                    textAlign(CENTER, CENTER);
                    textSize(10 + c.energia * 8);
                    text("◉", 0, 0);
                    pop();
                }
                
                if(c.resonancia > 0.6 && psyche.arquetiposActivos) {
                    stroke(c.color, 60, 100, c.resonancia * 40);
                    strokeWeight(1);
                    noFill();
                    ellipse(psyche.ego.x, c.y, tamActual * 3);
                }
            }
        }

        function dibujarSombra() {
            push();
            translate(psyche.sombra.x, psyche.sombra.y);
            
            noStroke();
            let sombraAlpha = psyche.modoConfronta ? 150 : lerp(40, 120, psyche.sombra.visibilidad);
            // --- EVOLUCIÓN --- Color afectado por hostilidad
            let hueSombra = lerp(280, 0, psyche.sombra.hostilidad);
            let brilloSombra = lerp(8, 20, psyche.sombra.hostilidad);
            fill(hueSombra, 60, brilloSombra, sombraAlpha);
            
            beginShape();
            for (let p of psyche.sombra.puntos) {
                let ruido = noise(p.ruidoOffset + psyche.tiempo * p.velocidad);
                let d = p.distancia + map(ruido, 0, 1, -40, 40) * p.intensidad * (1 + psyche.sombra.hostilidad);
                let x = cos(p.angulo) * d;
                let y = sin(p.angulo) * d;
                curveVertex(x, y);
            }
            endShape(CLOSE);
            
            if (psyche.sombra.energia > 0.2 || psyche.modoConfronta) {
                for (let f of psyche.sombra.fragmentos) {
                    push();
                    translate(f.x, f.y);
                    rotate(f.rotacion + psyche.tiempo * f.velocidadRot);
                    
                    let fragmentAlpha = (psyche.modoConfronta ? f.alpha * 2 : f.alpha * psyche.sombra.energia * 3);
                    let hueVariacion = f.arquetipo * 20 + sin(psyche.tiempo + f.x * 0.1) * 15;
                    fill(275 + hueVariacion, 70, 60, fragmentAlpha);
                    
                    let pulsacion = 1 + sin(psyche.tiempo * f.pulsacion + f.rotacion) * 0.3;
                    let tamFinal = f.tam * pulsacion;
                    
                    switch(f.arquetipo) {
                        case 0: ellipse(0, 0, tamFinal); break;
                        case 1: rect(-tamFinal/2, -tamFinal/2, tamFinal, tamFinal); break;
                        case 2: triangle(-tamFinal/2, tamFinal/2, tamFinal/2, tamFinal/2, 0, -tamFinal/2); break;
                        case 3: 
                            beginShape();
                            for(let a = 0; a < TWO_PI; a += PI/6) {
                                let r1 = tamFinal/2; let r2 = tamFinal/4;
                                vertex(cos(a) * r1, sin(a) * r1);
                                vertex(cos(a + PI/6) * r2, sin(a + PI/6) * r2);
                            }
                            endShape(CLOSE);
                            break;
                    }
                    
                    f.rotacion += f.velocidadRot;
                    pop();
                }
            }
            
            if(psyche.sombra.energia > 0.3 || psyche.modoConfronta) {
                let nucleoSize = lerp(15, 35, psyche.sombra.energia);
                let nucleoPulse = sin(psyche.tiempo * 3) * 5 * (1 + psyche.sombra.hostilidad * 2);
                
                fill(300, 80, 70, lerp(30, 100, psyche.sombra.energia));
                ellipse(0, 0, nucleoSize + nucleoPulse + 10);
                
                fill(0, 0, 5, 90);
                ellipse(0, 0, nucleoSize + nucleoPulse);
                
                if(psyche.integracion > 0.6) {
                    fill(0, 0, 100, psyche.integracion * 150);
                    ellipse(0, 0, 5);
                }
            }
            
            pop();
        }

        function dibujarConexionesPsiquicas() {
            if (psyche.integracion > 0.3) {
                for (let i = 0; i < psyche.chakras.length; i++) {
                    let c = psyche.chakras[i];
                    if(c.activo && c.resonancia > 0.4) {
                        let conexiones = Math.floor(psyche.integracion * 2) + 1;
                        
                        for(let j = 0; j < conexiones; j++) {
                            let offset = j * 0.4;
                            let variacion = sin(psyche.tiempo * 1.5 + i + offset) * 60;
                            
                            let puntoSombraX = psyche.sombra.x + cos(psyche.tiempo * 0.8 + i) * variacion * 0.7;
                            let puntoSombraY = psyche.sombra.y + sin(psyche.tiempo * 0.8 + i) * variacion * 0.7;
                            
                            strokeWeight(lerp(0.5, 2.5, psyche.integracion));
                            let alphaConexion = c.resonancia * 80;
                            stroke(c.color, 40, 95, alphaConexion);
                            
                            let puntoMedio1X = lerp(psyche.ego.x, puntoSombraX, 0.3) + sin(psyche.tiempo + i) * 40;
                            let puntoMedio1Y = lerp(c.y, puntoSombraY, 0.3) + cos(psyche.tiempo + i) * 30;
                            let puntoMedio2X = lerp(psyche.ego.x, puntoSombraX, 0.7) + sin(psyche.tiempo + i + PI) * 30;
                            let puntoMedio2Y = lerp(c.y, puntoSombraY, 0.7) + cos(psyche.tiempo + i + PI) * 40;
                            
                            noFill();
                            beginShape();
                            vertex(psyche.ego.x, c.y);
                            bezierVertex(puntoMedio1X, puntoMedio1Y, puntoMedio2X, puntoMedio2Y, puntoSombraX, puntoSombraY);
                            endShape();
                            
                            if(random() < 0.1) {
                                let t = (sin(psyche.tiempo * 2 + i * 0.5) + 1) / 2;
                                let flujoX = lerp(psyche.ego.x, puntoSombraX, t);
                                let flujoY = lerp(c.y, puntoSombraY, t);
                                
                                fill(c.color, 80, 100, 80);
                                noStroke();
                                ellipse(flujoX, flujoY, 3);
                            }
                        }
                    }
                }
            }
        }

        function dibujarArquetipos() { /* Sin cambios */ }
        function dibujarSimbolos() { /* Sin cambios */ }
        function dibujarMandalaIndividuacion() { /* Sin cambios */ }
        function getFaseTexto(fase) { return FASES_INDIVIDUACION[constrain(fase, 0, FASES_INDIVIDUACION.length - 1)]; }
        function getArquetipoLevel(tipo, energia) {
            let levels = ["Dormido", "Emergiendo", "Activo", "Integrado"];
            let index = Math.floor(energia * levels.length);
            return levels[constrain(index, 0, levels.length - 1)];
        }
        function getSimboloDominante(individuacion) {
            let index = Math.floor(individuacion * ARQUETIPOS_SIMBOLOS.length);
            return ARQUETIPOS_SIMBOLOS[constrain(index, 0, ARQUETIPOS_SIMBOLOS.length - 1)];
        }
        function actualizarInterfaz() { /* Sin cambios */ }
        function ocultarPantallaCarga() { /* Sin cambios */ }
        function mousePressed() { /* Sin cambios */ }
        function keyPressed() { /* Sin cambios */ }
        function mouseMoved() { /* Sin cambios */ }
        function windowResized() { /* Sin cambios */ }
        function limpiarParticulas() { /* Sin cambios */ }
        setInterval(limpiarParticulas, 3000);
    </script>
</body>
</html>
