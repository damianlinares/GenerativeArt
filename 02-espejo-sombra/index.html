<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LA GRAN OBRA: El Vaso Alquímico - Damian Alejandro Linares</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            width: 100%; height: 100vh;
            background: #000;
            overflow: hidden; font-family: 'Garamond', serif;
            cursor: none;
        }
        .dashboard {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 215, 0, 0.4);
            z-index: 100; box-shadow: 0 -5px 30px rgba(0, 0, 0, 0.7);
            display: flex; padding: 15px 30px;
            color: rgba(255, 255, 255, 0.8);
            align-items: center;
        }
        .dash-section {
            flex: 1; text-align: center;
        }
        .dash-section h4 {
            color: #FFD700; font-weight: normal; letter-spacing: 2px;
            font-size: 1em; margin-bottom: 8px;
        }
        .dash-section p {
            font-size: 1.5em; letter-spacing: 1px;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
        }
        .instructions {
            position: fixed; top: 30px; left: 50%;
            transform: translateX(-50%);
            color: rgba(255, 255, 255, 0.5);
            font-size: 1em;
            letter-spacing: 1px;
            transition: opacity 1s;
        }
    </style>
</head>
<body>
    <div class="instructions" id="instructions">Mantén presionado para iniciar la transmutación. Muévete lentamente para guiar la Obra.</div>
    <div class="dashboard">
        <div class="dash-section">
            <h4>FASE ALQUÍMICA</h4>
            <p id="phase">INICIAL</p>
        </div>
        <div class="dash-section">
            <h4>PROGRESO DE LA OBRA</h4>
            <p id="progress">0%</p>
        </div>
        <div class="dash-section">
            <h4>ESTADO DEL VASO</h4>
            <p id="vessel-state">INERTE</p>
        </div>
    </div>
    <script>
        // --- MOTOR ALQUÍMICO ---
        let particles = [];
        const NUM_PARTICLES = 2000;
        let flowField;
        let zOff = 0;
        
        let estado = 'INICIAL'; // INICIAL, NIGREDO, ALBEDO, CITRINITAS, RUBEDO
        let progreso = 0; // 0 a 1
        let calorAplicado = 0;
        
        let mouseVel = 0;

        function setup() {
            createCanvas(windowWidth, windowHeight);
            colorMode(HSB, 360, 100, 100, 100);
            inicializarParticulas();
        }

        function inicializarParticulas() {
            particles = [];
            for (let i = 0; i < NUM_PARTICLES; i++) {
                particles.push(new Particle(i < NUM_PARTICLES / 2));
            }
        }

        function draw() {
            background(260, 80, 5);

            // --- LÓGICA DE INTERACCIÓN Y ESTADOS ---
            mouseVel = dist(mouseX, mouseY, pmouseX, pmouseY);
            
            if (mouseIsPressed) {
                document.getElementById('instructions').style.opacity = '0';
                calorAplicado = min(1000, calorAplicado + 1);
                
                if(calorAplicado > 100) estado = 'NIGREDO';
                
                if (estado === 'NIGREDO' || estado === 'ALBEDO' || estado === 'CITRINITAS') {
                    if (mouseVel < 5) { // Movimiento lento y catalizador
                        progreso = min(1, progreso + 0.0005);
                    } else { // Movimiento brusco aumenta el caos
                        progreso = max(0, progreso - 0.001);
                    }
                }
            } else {
                calorAplicado = max(0, calorAplicado - 5);
                if (calorAplicado < 50 && estado !== 'RUBEDO') estado = 'INICIAL';
                progreso = max(0, progreso - 0.0002);
            }
            
            // Transiciones de estado
            if (progreso > 0.3 && estado === 'NIGREDO') estado = 'ALBEDO';
            if (progreso > 0.7 && estado === 'ALBEDO') estado = 'CITRINITAS';
            if (progreso >= 1 && estado === 'CITRINITAS') estado = 'RUBEDO';

            // --- ACTUALIZAR Y DIBUJAR PARTÍCULAS ---
            for (let p of particles) {
                p.updateAndDisplay();
            }

            // --- DIBUJAR CURSOR ALQUÍMICO ---
            dibujarCursor();
            
            // --- ACTUALIZAR DASHBOARD ---
            actualizarDashboard();
        }

        class Particle {
            constructor(isEgo) {
                this.isEgo = isEgo; // true = LUZ, false = SOMBRA
                this.pos = createVector(random(width), random(height));
                this.vel = createVector(0, 0);
                this.acc = createVector(0, 0);
                this.maxSpeed = 2;
                this.lifespan = 255;
            }

            applyForce(force) {
                this.acc.add(force);
            }

            update() {
                this.vel.add(this.acc);
                this.vel.limit(this.maxSpeed);
                this.pos.add(this.vel);
                this.acc.mult(0);
            }

            behaviors() {
                // Fuerzas según el estado alquímico
                switch(estado) {
                    case 'INICIAL':
                        // Se repelen
                        let repelCenter = this.isEgo ? createVector(width*0.25, height/2) : createVector(width*0.75, height/2);
                        let repelForce = p5.Vector.sub(repelCenter, this.pos);
                        repelForce.normalize();
                        repelForce.mult(-0.5);
                        this.applyForce(repelForce);
                        break;
                        
                    case 'NIGREDO':
                        // Turbulencia caótica
                        let angle = noise(this.pos.x * 0.005, this.pos.y * 0.005, zOff) * TWO_PI * 4;
                        let turbulence = p5.Vector.fromAngle(angle);
                        turbulence.setMag(1);
                        this.applyForce(turbulence);
                        break;
                        
                    case 'ALBEDO':
                    case 'CITRINITAS':
                        // Fuerza de atracción al centro para formar patrones
                        let center = createVector(width/2, height/2);
                        let attraction = p5.Vector.sub(center, this.pos);
                        attraction.normalize();
                        attraction.mult(0.1);
                        this.applyForce(attraction);
                        // Repulsión de partículas cercanas para crear estructura
                        for(let other of particles) {
                           let d = dist(this.pos.x, this.pos.y, other.pos.x, other.pos.y);
                           if(d > 0 && d < 10) {
                               let repel = p5.Vector.sub(this.pos, other.pos);
                               repel.normalize();
                               repel.mult(0.5);
                               this.applyForce(repel);
                           }
                        }
                        break;

                    case 'RUBEDO':
                        // Coalescencia final en el centro
                         let finalCenter = createVector(width/2, height/2);
                         let finalAttraction = p5.Vector.sub(finalCenter, this.pos);
                         let distToCenter = finalAttraction.mag();
                         finalAttraction.normalize();
                         finalAttraction.mult(map(distToCenter, 0, width/2, 0, 5));
                         this.applyForce(finalAttraction);
                         this.vel.mult(0.95); // Amortiguación para estabilizar
                        break;
                }
            }
            
            display() {
                // Color y forma según estado
                let c;
                let weight = 1.5;
                switch(estado) {
                    case 'INICIAL':
                        c = this.isEgo ? color(60, 80, 100, 80) : color(280, 80, 30, 80);
                        break;
                    case 'NIGREDO':
                        c = color(260, 30, 15, 70); // Oscuridad
                        weight = 2;
                        break;
                    case 'ALBEDO':
                        c = color(0, 0, 100, 70); // Blanco plateado
                        weight = lerp(2, 0.5, progreso);
                        break;
                    case 'CITRINITAS':
                        c = lerpColor(color(0, 0, 100, 70), color(50, 100, 100, 80), (progreso - 0.7) / 0.3);
                        break;
                    case 'RUBEDO':
                        c = color(0, 100, 100, 90); // Rojo final
                        break;
                }
                
                stroke(c);
                strokeWeight(weight);
                point(this.pos.x, this.pos.y);
            }

            updateAndDisplay() {
                this.behaviors();
                this.update();
                this.display();
            }
        }
        
        function dibujarCursor() {
            push();
            translate(mouseX, mouseY);
            noCursor();
            let size = 20 + calorAplicado * 0.05;
            let c = color(35, 100, 100, 80);
            if(estado === 'RUBEDO') c = color(0, 100, 100, 90);

            noFill();
            stroke(c);
            strokeWeight(2);
            for(let i=0; i < 3; i++) {
                rotate(frameCount * 0.01 * (i + 1));
                let s = size * (1 - i*0.2);
                ellipse(0, 0, s, s);
            }
            pop();
        }
        
        function actualizarDashboard() {
            document.getElementById('phase').textContent = estado;
            document.getElementById('progress').textContent = `${floor(progreso*100)}%`;
            let vesselStateText = 'INERTE';
            if (mouseIsPressed) {
                vesselStateText = mouseVel < 5 ? 'CATALIZANDO' : 'TURBULENTO';
            }
            if(estado === 'RUBEDO') vesselStateText = 'UNIFICADO';
            document.getElementById('vessel-state').textContent = vesselStateText;
        }

        function mousePressed() {
             if (estado === 'RUBEDO') {
                 estado = 'INICIAL';
                 progreso = 0;
                 calorAplicado = 0;
                 inicializarParticulas();
                 document.getElementById('instructions').style.opacity = '1';
             }
        }
    </script>
</body>
</html>
